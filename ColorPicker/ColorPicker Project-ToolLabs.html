<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chromatic — Color Studio</title>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

        :root {
            --bg-primary: #0a0a0b;
            --bg-secondary: #141416;
            --bg-tertiary: #1c1c1f;
            --bg-elevated: #242428;
            --text-primary: #ffffff;
            --text-secondary: #a1a1a6;
            --text-tertiary: #6e6e73;
            --border: #2c2c2e;
            --accent: #6366f1;
            --accent-hover: #818cf8;
            --success: #22c55e;
            --warning: #f59e0b;
            --error: #ef4444;
            --radius: 12px;
            --radius-sm: 8px;
            --shadow: 0 4px 24px rgba(0,0,0,0.4);
        }

        .theme-light {
            --bg-primary: #f5f5f7;
            --bg-secondary: #ffffff;
            --bg-tertiary: #e5e5ea;
            --bg-elevated: #ffffff;
            --text-primary: #1d1d1f;
            --text-secondary: #6e6e73;
            --text-tertiary: #aeaeb2;
            --border: #d1d1d6;
            --shadow: 0 4px 24px rgba(0,0,0,0.1);
        }

        .theme-midnight {
            --bg-primary: #0f0f23;
            --bg-secondary: #1a1a3e;
            --bg-tertiary: #252552;
            --bg-elevated: #2f2f66;
            --accent: #818cf8;
        }

        .theme-forest {
            --bg-primary: #0a0f0d;
            --bg-secondary: #121a16;
            --bg-tertiary: #1a251f;
            --bg-elevated: #223328;
            --accent: #4ade80;
        }

        .theme-sunset {
            --bg-primary: #1a0a0a;
            --bg-secondary: #2a1010;
            --bg-tertiary: #3a1818;
            --bg-elevated: #4a2020;
            --accent: #f97316;
        }

        body {
            font-family: 'DM Sans', -apple-system, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .app {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* Header */
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 24px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-icon {
            width: 32px;
            height: 32px;
            background: conic-gradient(from 0deg, #ff6b6b, #feca57, #48dbfb, #ff9ff3, #ff6b6b);
            border-radius: 50%;
            animation: spin 10s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .logo h1 {
            font-size: 20px;
            font-weight: 600;
            background: linear-gradient(135deg, var(--text-primary), var(--text-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .nav-tabs {
            display: flex;
            gap: 4px;
            background: var(--bg-tertiary);
            padding: 4px;
            border-radius: var(--radius);
        }

        .nav-tab {
            padding: 8px 16px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 500;
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all 0.2s;
        }

        .nav-tab:hover {
            color: var(--text-primary);
        }

        .nav-tab.active {
            background: var(--bg-elevated);
            color: var(--text-primary);
            box-shadow: var(--shadow);
        }

        .header-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .theme-selector {
            display: flex;
            gap: 4px;
            padding: 4px;
            background: var(--bg-tertiary);
            border-radius: var(--radius-sm);
        }

        .theme-btn {
            width: 24px;
            height: 24px;
            border: 2px solid transparent;
            border-radius: 50%;
            cursor: pointer;
            transition: transform 0.2s, border-color 0.2s;
        }

        .theme-btn:hover {
            transform: scale(1.1);
        }

        .theme-btn.active {
            border-color: var(--text-primary);
        }

        .theme-btn[data-theme="dark"] { background: #0a0a0b; }
        .theme-btn[data-theme="light"] { background: #f5f5f7; }
        .theme-btn[data-theme="midnight"] { background: linear-gradient(135deg, #1a1a3e, #4f46e5); }
        .theme-btn[data-theme="forest"] { background: linear-gradient(135deg, #121a16, #22c55e); }
        .theme-btn[data-theme="sunset"] { background: linear-gradient(135deg, #2a1010, #f97316); }

        .btn-icon {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid var(--border);
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-icon:hover {
            background: var(--bg-elevated);
            color: var(--text-primary);
            border-color: var(--accent);
        }

        /* Main Layout */
        .main {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .view {
            display: none;
            flex: 1;
            padding: 24px;
        }

        .view.active {
            display: block;
        }

        /* Color Wheel View */
        .wheel-view {
            display: none;
            gap: 32px;
        }

        .wheel-view.active {
            display: grid;
            grid-template-columns: 1fr 350px;
        }

        .wheel-section {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .wheel-container {
            position: relative;
            width: 100%;
            max-width: 500px;
            aspect-ratio: 1;
            margin: 0 auto;
        }

        #colorWheel {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            cursor: crosshair;
        }

        .wheel-handle {
            position: absolute;
            width: 28px;
            height: 28px;
            border: 3px solid white;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            cursor: grab;
            box-shadow: 0 2px 8px rgba(0,0,0,0.4), inset 0 0 0 2px rgba(0,0,0,0.2);
            transition: transform 0.1s, box-shadow 0.2s;
            z-index: 10;
        }

        .wheel-handle:hover {
            transform: translate(-50%, -50%) scale(1.15);
        }

        .wheel-handle.active {
            transform: translate(-50%, -50%) scale(1.2);
            box-shadow: 0 4px 16px rgba(0,0,0,0.5), inset 0 0 0 2px rgba(0,0,0,0.2), 0 0 0 4px var(--accent);
            cursor: grabbing;
            z-index: 20;
        }

        .wheel-handle.selected {
            box-shadow: 0 2px 8px rgba(0,0,0,0.4), inset 0 0 0 2px rgba(0,0,0,0.2), 0 0 0 3px var(--accent);
        }

        .wheel-connection {
            position: absolute;
            pointer-events: none;
            z-index: 5;
        }

        .wheel-connection line {
            stroke: rgba(255,255,255,0.3);
            stroke-width: 2;
            stroke-dasharray: 4 4;
        }

        .wheel-center {
            position: absolute;
            width: 12px;
            height: 12px;
            background: rgba(255,255,255,0.8);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            z-index: 6;
            pointer-events: none;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }

        /* Harmony Controls */
        .harmony-section {
            background: var(--bg-secondary);
            border-radius: var(--radius);
            padding: 20px;
            border: 1px solid var(--border);
        }

        .harmony-section h3 {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 16px;
        }

        .harmony-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
        }

        .harmony-btn {
            aspect-ratio: 1;
            border: 1px solid var(--border);
            background: var(--bg-tertiary);
            border-radius: var(--radius-sm);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            position: relative;
        }

        .harmony-btn svg {
            width: 24px;
            height: 24px;
            stroke: var(--text-secondary);
            fill: none;
            stroke-width: 2;
        }

        .harmony-btn:hover {
            background: var(--bg-elevated);
            border-color: var(--accent);
        }

        .harmony-btn:hover svg {
            stroke: var(--text-primary);
        }

        .harmony-btn.active {
            background: var(--accent);
            border-color: var(--accent);
        }

        .harmony-btn.active svg {
            stroke: white;
        }

        .harmony-btn::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: calc(100% + 8px);
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-elevated);
            color: var(--text-primary);
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 11px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
            box-shadow: var(--shadow);
        }

        .harmony-btn:hover::after {
            opacity: 1;
        }

        /* Color Count Control */
        .color-count {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--border);
        }

        .color-count label {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .count-control {
            display: flex;
            align-items: center;
            gap: 8px;
            background: var(--bg-tertiary);
            padding: 4px;
            border-radius: var(--radius-sm);
        }

        .count-btn {
            width: 28px;
            height: 28px;
            border: none;
            background: var(--bg-elevated);
            color: var(--text-primary);
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: background 0.2s;
        }

        .count-btn:hover {
            background: var(--accent);
        }

        .count-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .count-value {
            width: 32px;
            text-align: center;
            font-weight: 600;
            font-size: 14px;
        }

        /* Color Panel */
        .color-panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .panel-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 20px;
        }

        .panel-card h3 {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 16px;
        }

        /* Slider Tabs */
        .slider-tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 16px;
            background: var(--bg-tertiary);
            padding: 4px;
            border-radius: var(--radius-sm);
        }

        .slider-tab {
            flex: 1;
            padding: 6px 12px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-size: 12px;
            font-weight: 600;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .slider-tab:hover {
            color: var(--text-primary);
        }

        .slider-tab.active {
            background: var(--bg-elevated);
            color: var(--text-primary);
        }

        .slider-group {
            display: none;
        }

        .slider-group.active {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .slider-row {
            display: grid;
            grid-template-columns: 24px 1fr 60px 20px;
            align-items: center;
            gap: 12px;
        }

        .slider-row label {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-tertiary);
        }

        .slider-track {
            height: 8px;
            border-radius: 4px;
            position: relative;
            overflow: hidden;
        }

        .slider-track input[type="range"] {
            width: 100%;
            height: 100%;
            -webkit-appearance: none;
            background: transparent;
            cursor: pointer;
        }

        .slider-track input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: white;
            border: 2px solid var(--bg-primary);
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            cursor: grab;
        }

        .slider-track input[type="range"]::-webkit-slider-thumb:active {
            cursor: grabbing;
        }

        .hue-track {
            background: linear-gradient(to right, #ff0000, #ffff00, #00ff00, #00ffff, #0000ff, #ff00ff, #ff0000);
        }

        .slider-row input[type="number"] {
            width: 100%;
            padding: 6px 8px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            text-align: center;
        }

        .slider-row input[type="number"]:focus {
            outline: none;
            border-color: var(--accent);
        }

        .slider-row .unit {
            font-size: 11px;
            color: var(--text-tertiary);
        }

        /* Hex Input */
        .hex-group {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .hex-field {
            flex: 1;
            display: flex;
            align-items: center;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            padding: 0 12px;
            transition: border-color 0.2s;
        }

        .hex-field:focus-within {
            border-color: var(--accent);
        }

        .hex-field .hash {
            color: var(--text-tertiary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 14px;
        }

        .hex-field input {
            flex: 1;
            padding: 10px 8px;
            background: transparent;
            border: none;
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 14px;
            text-transform: uppercase;
        }

        .hex-field input:focus {
            outline: none;
        }

        .copy-btn {
            padding: 8px;
            background: transparent;
            border: none;
            color: var(--text-tertiary);
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .copy-btn:hover {
            background: var(--bg-elevated);
            color: var(--text-primary);
        }

        /* Palette Grid in Panel */
        .palette-grid {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .palette-grid-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px;
            background: var(--bg-tertiary);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all 0.2s;
        }

        .palette-grid-item:hover {
            background: var(--bg-elevated);
        }

        .palette-grid-item.selected {
            box-shadow: 0 0 0 2px var(--accent);
            background: var(--bg-elevated);
        }

        .palette-grid-swatch {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            flex-shrink: 0;
        }

        .palette-grid-info {
            flex: 1;
            min-width: 0;
        }

        .palette-grid-hex {
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
            font-weight: 500;
        }

        .palette-grid-name {
            font-size: 11px;
            color: var(--text-tertiary);
        }

        /* Extract View */
        .extract-view {
            display: none;
            gap: 24px;
        }

        .extract-view.active {
            display: grid;
            grid-template-columns: 1fr 350px;
        }

        .upload-zone {
            background: var(--bg-secondary);
            border: 2px dashed var(--border);
            border-radius: var(--radius);
            min-height: 400px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }

        .upload-zone:hover {
            border-color: var(--accent);
            background: var(--bg-tertiary);
        }

        .upload-zone.has-image {
            border-style: solid;
        }

        .upload-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            color: var(--text-secondary);
        }

        .upload-content svg {
            stroke: var(--text-tertiary);
        }

        .upload-content p {
            font-size: 16px;
            font-weight: 500;
        }

        .upload-content span {
            font-size: 13px;
            color: var(--text-tertiary);
        }

        .preview-image {
            width: 100%;
            height: 100%;
            object-fit: contain;
            display: none;
        }

        .upload-zone.has-image .upload-content {
            display: none;
        }

        .upload-zone.has-image .preview-image {
            display: block;
        }

        .extract-panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .extracted-colors {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .extracted-color {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--bg-tertiary);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: background 0.2s;
        }

        .extracted-color:hover {
            background: var(--bg-elevated);
        }

        .extracted-swatch {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        .extracted-info {
            flex: 1;
        }

        .extracted-hex {
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
            font-weight: 500;
        }

        .extracted-percent {
            font-size: 11px;
            color: var(--text-tertiary);
        }

        /* Gradient View */
        .gradient-view {
            display: none;
            gap: 24px;
        }

        .gradient-view.active {
            display: grid;
            grid-template-columns: 1fr 350px;
        }

        .gradient-canvas {
            background: var(--bg-secondary);
            border-radius: var(--radius);
            overflow: hidden;
            position: relative;
        }

        .gradient-preview {
            width: 100%;
            min-height: 300px;
            background: linear-gradient(90deg, #ff0000, #0000ff);
        }

        .gradient-bar {
            height: 50px;
            position: relative;
            margin: 20px;
        }

        .gradient-track {
            height: 24px;
            border-radius: 12px;
            background: linear-gradient(90deg, #ff0000, #0000ff);
        }

        .gradient-stops {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 24px;
        }

        .gradient-stop {
            position: absolute;
            top: 50%;
            width: 20px;
            height: 20px;
            border: 3px solid white;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            cursor: grab;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }

        .gradient-stop.active {
            box-shadow: 0 0 0 3px var(--accent), 0 2px 6px rgba(0,0,0,0.3);
        }

        .gradient-colors-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .gradient-color-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--bg-tertiary);
            border-radius: var(--radius-sm);
        }

        .gradient-color-swatch {
            width: 44px;
            height: 44px;
            border-radius: 8px;
            border: 2px solid var(--border);
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .gradient-color-swatch input[type="color"] {
            position: absolute;
            inset: -10px;
            width: calc(100% + 20px);
            height: calc(100% + 20px);
            cursor: pointer;
            opacity: 0;
        }

        .gradient-color-controls {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .gradient-color-hex {
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
            font-weight: 500;
        }

        .gradient-position-row {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .gradient-position-row input[type="range"] {
            flex: 1;
            height: 6px;
            -webkit-appearance: none;
            appearance: none;
            background: var(--bg-elevated);
            border-radius: 3px;
            cursor: pointer;
        }

        .gradient-position-row input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--accent);
            cursor: grab;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .gradient-position-row span {
            font-size: 11px;
            color: var(--text-tertiary);
            min-width: 32px;
            text-align: right;
        }

        .gradient-color-remove {
            width: 28px;
            height: 28px;
            border: none;
            background: var(--bg-elevated);
            color: var(--text-tertiary);
            border-radius: 6px;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .gradient-color-remove:hover {
            background: var(--error);
            color: white;
        }

        .gradient-color-remove:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .gradient-color-remove:disabled:hover {
            background: var(--bg-elevated);
            color: var(--text-tertiary);
        }

        .gradient-panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .gradient-type-btns {
            display: flex;
            gap: 8px;
        }

        .gradient-type-btns button {
            flex: 1;
            padding: 10px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .gradient-type-btns button:hover {
            background: var(--bg-elevated);
            color: var(--text-primary);
        }

        .gradient-type-btns button.active {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
        }

        .angle-control {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .angle-control input[type="range"] {
            flex: 1;
        }

        .gradient-code {
            background: var(--bg-tertiary);
            border-radius: var(--radius-sm);
            padding: 16px;
            position: relative;
        }

        .gradient-code code {
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            color: var(--text-secondary);
            word-break: break-all;
        }

        /* Accessibility View */
        .a11y-view {
            display: none;
            gap: 24px;
        }

        .a11y-view.active {
            display: grid;
            grid-template-columns: 1fr 1fr;
        }

        .contrast-checker {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .color-inputs {
            display: flex;
            gap: 16px;
            align-items: flex-end;
        }

        .color-input-group {
            flex: 1;
        }

        .color-input-group label {
            display: block;
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .color-input-wrap {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .color-swatch-input {
            width: 48px;
            height: 48px;
            border-radius: var(--radius-sm);
            border: 2px solid var(--border);
            cursor: pointer;
        }

        .color-input-wrap input[type="text"] {
            flex: 1;
            padding: 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 14px;
        }

        .swap-btn {
            width: 40px;
            height: 40px;
            border: 1px solid var(--border);
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            border-radius: var(--radius-sm);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .swap-btn:hover {
            background: var(--bg-elevated);
            color: var(--text-primary);
        }

        .contrast-preview {
            padding: 40px;
            border-radius: var(--radius);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
        }

        .preview-large {
            font-size: 72px;
            font-weight: 700;
        }

        .preview-small {
            font-size: 14px;
        }

        .contrast-result {
            text-align: center;
            padding: 24px;
            background: var(--bg-secondary);
            border-radius: var(--radius);
        }

        .ratio-value {
            font-size: 48px;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
        }

        .ratio-label {
            font-size: 13px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .wcag-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 20px;
        }

        .wcag-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: var(--bg-tertiary);
            border-radius: var(--radius-sm);
        }

        .wcag-label {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .wcag-status {
            font-size: 12px;
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 4px;
        }

        .wcag-status.pass {
            background: rgba(34, 197, 94, 0.2);
            color: var(--success);
        }

        .wcag-status.fail {
            background: rgba(239, 68, 68, 0.2);
            color: var(--error);
        }

        /* Mini Color Wheel for Accessibility */
        .a11y-color-picker {
            position: relative;
            width: 150px;
            height: 150px;
        }

        .a11y-color-picker canvas {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            cursor: crosshair;
        }

        .a11y-handle {
            position: absolute;
            width: 16px;
            height: 16px;
            border: 2px solid white;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
            box-shadow: 0 2px 6px rgba(0,0,0,0.4);
        }

        .a11y-color-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
            align-items: center;
        }

        .a11y-color-group label {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .a11y-hex-input {
            width: 100%;
            max-width: 150px;
            padding: 8px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
            text-align: center;
            text-transform: uppercase;
        }

        /* Color input popup */
        .color-popup {
            display: none;
            position: fixed;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 16px;
            box-shadow: var(--shadow);
            z-index: 1000;
        }

        .color-popup.active {
            display: block;
        }

        .color-popup-close {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 24px;
            height: 24px;
            border: none;
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            border-radius: 50%;
            cursor: pointer;
            font-size: 14px;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-overlay {
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
        }

        .modal-content {
            position: relative;
            background: var(--bg-secondary);
            border-radius: var(--radius);
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow: auto;
            box-shadow: var(--shadow);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
        }

        .modal-header h2 {
            font-size: 18px;
            font-weight: 600;
        }

        .modal-close {
            width: 32px;
            height: 32px;
            border: none;
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-body {
            padding: 24px;
        }

        .export-options {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 24px;
        }

        .export-option {
            padding: 20px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .export-option:hover {
            background: var(--bg-elevated);
            border-color: var(--accent);
        }

        .export-option.active {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
        }

        .export-option svg {
            stroke: currentColor;
        }

        .export-option span {
            font-size: 12px;
            font-weight: 500;
        }

        .export-preview {
            background: var(--bg-tertiary);
            border-radius: var(--radius-sm);
            padding: 16px;
            max-height: 200px;
            overflow: auto;
        }

        .export-preview pre {
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            color: var(--text-secondary);
            white-space: pre-wrap;
        }

        .export-actions {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }

        .btn-primary, .btn-secondary {
            flex: 1;
            padding: 12px 24px;
            border-radius: var(--radius-sm);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--accent);
            border: none;
            color: white;
        }

        .btn-primary:hover {
            background: var(--accent-hover);
        }

        .btn-secondary {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-primary);
        }

        .btn-secondary:hover {
            background: var(--bg-tertiary);
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(20px);
            background: var(--bg-elevated);
            color: var(--text-primary);
            padding: 12px 24px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            opacity: 0;
            pointer-events: none;
            transition: all 0.3s;
            z-index: 1001;
        }

        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
    </style>
</head>
<body>
    <div class="app">
        <header class="header">
            <div class="logo">
                <div class="logo-icon"></div>
                <h1>Chromatic</h1>
            </div>
            <nav class="nav-tabs">
                <button class="nav-tab active" data-view="wheel">Color Wheel</button>
                <button class="nav-tab" data-view="extract">Extract</button>
                <button class="nav-tab" data-view="gradient">Gradient</button>
                <button class="nav-tab" data-view="a11y">Accessibility</button>
            </nav>
            <div class="header-actions">
                <div class="theme-selector">
                    <button class="theme-btn active" data-theme="dark" title="Dark"></button>
                    <button class="theme-btn" data-theme="light" title="Light"></button>
                    <button class="theme-btn" data-theme="midnight" title="Midnight"></button>
                    <button class="theme-btn" data-theme="forest" title="Forest"></button>
                    <button class="theme-btn" data-theme="sunset" title="Sunset"></button>
                </div>
                <button class="btn-icon" id="saveBtn" title="Save Palette">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
                        <polyline points="17,21 17,13 7,13 7,21"/>
                        <polyline points="7,3 7,8 15,8"/>
                    </svg>
                </button>
                <button class="btn-icon" id="exportBtn" title="Export">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="7,10 12,15 17,10"/>
                        <line x1="12" y1="15" x2="12" y2="3"/>
                    </svg>
                </button>
            </div>
        </header>

        <main class="main">
            <!-- Color Wheel View -->
            <section class="view wheel-view active" id="wheelView">
                <div class="wheel-section">
                    <div class="wheel-container" id="wheelContainer">
                        <canvas id="colorWheel"></canvas>
                    </div>
                    <div class="panel-card" style="margin-top:20px;">
                        <div class="hex-group" style="margin-bottom:16px;">
                            <div class="hex-field">
                                <span class="hash">#</span>
                                <input type="text" id="hexInput" value="FF0000" maxlength="6">
                            </div>
                            <button class="copy-btn" id="copyHex">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="9" y="9" width="13" height="13" rx="2"/>
                                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                                </svg>
                            </button>
                        </div>
                        <div class="slider-tabs">
                            <button class="slider-tab active" data-mode="hsb">HSB</button>
                            <button class="slider-tab" data-mode="rgb">RGB</button>
                            <button class="slider-tab" data-mode="cmyk">CMYK</button>
                            <button class="slider-tab" data-mode="lab">LAB</button>
                        </div>
                        <div class="slider-group active" data-mode="hsb">
                            <div class="slider-row">
                                <label>H</label>
                                <div class="slider-track hue-track"><input type="range" id="hueSlider" min="0" max="360" value="0"></div>
                                <input type="number" id="hueInput" min="0" max="360" value="0">
                                <span class="unit">°</span>
                            </div>
                            <div class="slider-row">
                                <label>S</label>
                                <div class="slider-track" id="satTrack"><input type="range" id="satSlider" min="0" max="100" value="100"></div>
                                <input type="number" id="satInput" min="0" max="100" value="100">
                                <span class="unit">%</span>
                            </div>
                            <div class="slider-row">
                                <label>B</label>
                                <div class="slider-track" id="brightTrack"><input type="range" id="brightSlider" min="0" max="100" value="100"></div>
                                <input type="number" id="brightInput" min="0" max="100" value="100">
                                <span class="unit">%</span>
                            </div>
                        </div>
                        <div class="slider-group" data-mode="rgb">
                            <div class="slider-row">
                                <label>R</label>
                                <div class="slider-track" style="background:linear-gradient(to right,#000,#f00)"><input type="range" id="redSlider" min="0" max="255" value="255"></div>
                                <input type="number" id="redInput" min="0" max="255" value="255">
                                <span class="unit"></span>
                            </div>
                            <div class="slider-row">
                                <label>G</label>
                                <div class="slider-track" style="background:linear-gradient(to right,#000,#0f0)"><input type="range" id="greenSlider" min="0" max="255" value="0"></div>
                                <input type="number" id="greenInput" min="0" max="255" value="0">
                                <span class="unit"></span>
                            </div>
                            <div class="slider-row">
                                <label>B</label>
                                <div class="slider-track" style="background:linear-gradient(to right,#000,#00f)"><input type="range" id="blueSlider" min="0" max="255" value="0"></div>
                                <input type="number" id="blueInput" min="0" max="255" value="0">
                                <span class="unit"></span>
                            </div>
                        </div>
                        <div class="slider-group" data-mode="cmyk">
                            <div class="slider-row">
                                <label>C</label>
                                <div class="slider-track" style="background:linear-gradient(to right,#fff,#0ff)"><input type="range" id="cyanSlider" min="0" max="100" value="0"></div>
                                <input type="number" id="cyanInput" min="0" max="100" value="0">
                                <span class="unit">%</span>
                            </div>
                            <div class="slider-row">
                                <label>M</label>
                                <div class="slider-track" style="background:linear-gradient(to right,#fff,#f0f)"><input type="range" id="magentaSlider" min="0" max="100" value="100"></div>
                                <input type="number" id="magentaInput" min="0" max="100" value="100">
                                <span class="unit">%</span>
                            </div>
                            <div class="slider-row">
                                <label>Y</label>
                                <div class="slider-track" style="background:linear-gradient(to right,#fff,#ff0)"><input type="range" id="yellowSlider" min="0" max="100" value="100"></div>
                                <input type="number" id="yellowInput" min="0" max="100" value="100">
                                <span class="unit">%</span>
                            </div>
                            <div class="slider-row">
                                <label>K</label>
                                <div class="slider-track" style="background:linear-gradient(to right,#fff,#000)"><input type="range" id="blackSlider" min="0" max="100" value="0"></div>
                                <input type="number" id="blackInput" min="0" max="100" value="0">
                                <span class="unit">%</span>
                            </div>
                        </div>
                        <div class="slider-group" data-mode="lab">
                            <div class="slider-row">
                                <label>L</label>
                                <div class="slider-track" style="background:linear-gradient(to right,#000,#fff)"><input type="range" id="lSlider" min="0" max="100" value="53"></div>
                                <input type="number" id="lInput" min="0" max="100" value="53">
                                <span class="unit"></span>
                            </div>
                            <div class="slider-row">
                                <label>a</label>
                                <div class="slider-track" style="background:linear-gradient(to right,#00ff00,#ff00ff)"><input type="range" id="aSlider" min="-128" max="127" value="80"></div>
                                <input type="number" id="aInput" min="-128" max="127" value="80">
                                <span class="unit"></span>
                            </div>
                            <div class="slider-row">
                                <label>b</label>
                                <div class="slider-track" style="background:linear-gradient(to right,#0000ff,#ffff00)"><input type="range" id="bSlider" min="-128" max="127" value="67"></div>
                                <input type="number" id="bInput" min="-128" max="127" value="67">
                                <span class="unit"></span>
                            </div>
                        </div>
                    </div>
                    <div class="harmony-section">
                        <h3>Harmony Rule</h3>
                        <div class="harmony-grid">
                            <button class="harmony-btn active" data-harmony="custom" data-tooltip="Custom">
                                <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="3" fill="currentColor" stroke="none"/></svg>
                            </button>
                            <button class="harmony-btn" data-harmony="analogous" data-tooltip="Analogous">
                                <svg viewBox="0 0 24 24"><path d="M12 4 L8 12 L12 20 L16 12 Z"/></svg>
                            </button>
                            <button class="harmony-btn" data-harmony="monochromatic" data-tooltip="Monochromatic">
                                <svg viewBox="0 0 24 24"><circle cx="12" cy="6" r="2"/><circle cx="12" cy="12" r="2"/><circle cx="12" cy="18" r="2"/></svg>
                            </button>
                            <button class="harmony-btn" data-harmony="triad" data-tooltip="Triad">
                                <svg viewBox="0 0 24 24"><polygon points="12,4 4,18 20,18"/></svg>
                            </button>
                            <button class="harmony-btn" data-harmony="complementary" data-tooltip="Complementary">
                                <svg viewBox="0 0 24 24"><circle cx="12" cy="6" r="3"/><circle cx="12" cy="18" r="3"/></svg>
                            </button>
                            <button class="harmony-btn" data-harmony="split-complementary" data-tooltip="Split Complementary">
                                <svg viewBox="0 0 24 24"><circle cx="12" cy="5" r="2"/><circle cx="6" cy="18" r="2"/><circle cx="18" cy="18" r="2"/></svg>
                            </button>
                            <button class="harmony-btn" data-harmony="double-split" data-tooltip="Double Split">
                                <svg viewBox="0 0 24 24"><circle cx="8" cy="5" r="2"/><circle cx="16" cy="5" r="2"/><circle cx="8" cy="19" r="2"/><circle cx="16" cy="19" r="2"/></svg>
                            </button>
                            <button class="harmony-btn" data-harmony="square" data-tooltip="Square">
                                <svg viewBox="0 0 24 24"><rect x="6" y="6" width="12" height="12" rx="1"/></svg>
                            </button>
                            <button class="harmony-btn" data-harmony="compound" data-tooltip="Compound">
                                <svg viewBox="0 0 24 24"><circle cx="12" cy="4" r="2"/><circle cx="18" cy="10" r="2"/><circle cx="6" cy="14" r="2"/><circle cx="12" cy="20" r="2"/></svg>
                            </button>
                            <button class="harmony-btn" data-harmony="shades" data-tooltip="Shades">
                                <svg viewBox="0 0 24 24"><rect x="4" y="6" width="4" height="12" rx="1" opacity="0.3"/><rect x="10" y="6" width="4" height="12" rx="1" opacity="0.6"/><rect x="16" y="6" width="4" height="12" rx="1"/></svg>
                            </button>
                        </div>
                        <div class="color-count">
                            <label>Colors:</label>
                            <div class="count-control">
                                <button class="count-btn" id="decreaseColors">−</button>
                                <span class="count-value" id="colorCount">5</span>
                                <button class="count-btn" id="increaseColors">+</button>
                            </div>
                        </div>
                        <div class="color-count" style="margin-top:12px;padding-top:12px;border-top:1px solid var(--border);">
                            <label>Brightness:</label>
                            <input type="range" id="globalBrightness" min="10" max="100" value="100" style="flex:1;margin-left:12px;">
                            <span id="brightnessValue" style="width:36px;text-align:right;font-size:13px;">100%</span>
                        </div>
                    </div>
                </div>
                <div class="color-panel">
                    <div class="panel-card">
                        <h3>Palette</h3>
                        <div class="palette-grid" id="palettePanelColors"></div>
                    </div>
                </div>
            </section>

            <!-- Extract View -->
            <section class="view extract-view" id="extractView">
                <div class="upload-zone" id="uploadZone">
                    <input type="file" id="imageInput" accept="image/*" hidden>
                    <div class="upload-content">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <rect x="3" y="3" width="18" height="18" rx="2"/>
                            <circle cx="8.5" cy="8.5" r="1.5"/>
                            <path d="M21 15l-5-5L5 21"/>
                        </svg>
                        <p>Drop an image or click to upload</p>
                        <span>JPG, PNG, WebP supported</span>
                    </div>
                    <img class="preview-image" id="previewImage" alt="Preview">
                    <canvas id="extractCanvas" hidden></canvas>
                </div>
                <div class="extract-panel">
                    <div class="panel-card">
                        <h3>Extracted Colors</h3>
                        <div class="extracted-colors" id="extractedColors">
                            <p style="color:var(--text-tertiary);font-size:13px;">Upload an image to extract colors</p>
                        </div>
                    </div>
                    <button class="btn-primary" id="applyExtracted" disabled>Apply to Palette</button>
                </div>
            </section>

            <!-- Gradient View -->
            <section class="view gradient-view" id="gradientView">
                <div class="gradient-canvas">
                    <div class="gradient-preview" id="gradientPreview"></div>
                    <div class="gradient-bar">
                        <div class="gradient-track" id="gradientTrack"></div>
                        <div class="gradient-stops" id="gradientStops"></div>
                    </div>
                </div>
                <div class="gradient-panel">
                    <div class="panel-card">
                        <h3>Colors</h3>
                        <div class="gradient-colors-list" id="gradientColorsList"></div>
                        <button class="btn-secondary" id="addStop" style="margin-top:12px;width:100%;">+ Add Color</button>
                    </div>
                    <div class="panel-card">
                        <h3>Type</h3>
                        <div class="gradient-type-btns">
                            <button class="active" data-type="linear">Linear</button>
                            <button data-type="radial">Radial</button>
                            <button data-type="conic">Conic</button>
                        </div>
                    </div>
                    <div class="panel-card" id="anglePanel">
                        <h3>Angle</h3>
                        <div class="angle-control">
                            <input type="range" id="gradientAngle" min="0" max="360" value="90">
                            <input type="number" id="angleInput" min="0" max="360" value="90" style="width:60px;padding:8px;background:var(--bg-tertiary);border:1px solid var(--border);border-radius:6px;color:var(--text-primary);font-family:'JetBrains Mono',monospace;font-size:13px;">
                            <span class="unit">°</span>
                        </div>
                    </div>
                    <div class="panel-card">
                        <h3>CSS Output</h3>
                        <div class="gradient-code">
                            <code id="gradientCSS">linear-gradient(90deg, #FF0000 0%, #0000FF 100%)</code>
                        </div>
                        <button class="btn-secondary" id="copyGradient" style="margin-top:12px;width:100%;">Copy CSS</button>
                    </div>
                    <button class="btn-secondary" id="reverseGradient" style="width:100%;">Reverse</button>
                </div>
            </section>

            <!-- Accessibility View -->
            <section class="view a11y-view" id="a11yView">
                <div class="contrast-checker">
                    <div class="panel-card">
                        <h3>Contrast Checker</h3>
                        <div style="display:flex;gap:24px;align-items:flex-start;justify-content:center;flex-wrap:wrap;">
                            <div class="a11y-color-group">
                                <label>Foreground</label>
                                <div class="a11y-color-picker" id="fgPicker">
                                    <canvas id="fgWheel"></canvas>
                                    <div class="a11y-handle" id="fgHandle"></div>
                                </div>
                                <input type="text" class="a11y-hex-input" id="fgColor" value="#000000">
                            </div>
                            <button class="swap-btn" id="swapColors" style="margin-top:80px;">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M7 16V4m0 0L3 8m4-4l4 4M17 8v12m0 0l4-4m-4 4l-4-4"/>
                                </svg>
                            </button>
                            <div class="a11y-color-group">
                                <label>Background</label>
                                <div class="a11y-color-picker" id="bgPicker">
                                    <canvas id="bgWheel"></canvas>
                                    <div class="a11y-handle" id="bgHandle"></div>
                                </div>
                                <input type="text" class="a11y-hex-input" id="bgColor" value="#FFFFFF">
                            </div>
                        </div>
                    </div>
                    <div class="contrast-preview" id="contrastPreview" style="background:#FFFFFF;color:#000000;">
                        <span class="preview-large">Aa</span>
                        <span class="preview-small">The quick brown fox jumps over the lazy dog.</span>
                    </div>
                    <div class="contrast-result">
                        <div class="ratio-value" id="contrastRatio">21:1</div>
                        <div class="ratio-label">Contrast Ratio</div>
                        <div class="wcag-grid">
                            <div class="wcag-item"><span class="wcag-label">AA Normal</span><span class="wcag-status pass" id="aaNormal">Pass</span></div>
                            <div class="wcag-item"><span class="wcag-label">AA Large</span><span class="wcag-status pass" id="aaLarge">Pass</span></div>
                            <div class="wcag-item"><span class="wcag-label">AAA Normal</span><span class="wcag-status pass" id="aaaNormal">Pass</span></div>
                            <div class="wcag-item"><span class="wcag-label">AAA Large</span><span class="wcag-status pass" id="aaaLarge">Pass</span></div>
                        </div>
                    </div>
                </div>
                <div class="panel-card">
                    <h3>Use Palette Colors</h3>
                    <p style="font-size:13px;color:var(--text-secondary);margin-bottom:16px;">Click a color to set as foreground.</p>
                    <div id="a11yPaletteColors" style="display:flex;gap:8px;flex-wrap:wrap;"></div>
                </div>
            </section>
        </main>

    </div>

    <!-- Export Modal -->
    <div class="modal" id="exportModal">
        <div class="modal-overlay"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h2>Export Palette</h2>
                <button class="modal-close" id="closeExport">&times;</button>
            </div>
            <div class="modal-body">
                <div class="export-options">
                    <button class="export-option active" data-format="css"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/></svg><span>CSS</span></button>
                    <button class="export-option" data-format="scss"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/></svg><span>SCSS</span></button>
                    <button class="export-option" data-format="json"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14,2 14,8 20,8"/></svg><span>JSON</span></button>
                    <button class="export-option" data-format="tailwind"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 6c-2.67 0-4.33 1.33-5 4 1-1.33 2.17-1.83 3.5-1.5.76.19 1.31.74 1.91 1.35.98 1 2.11 2.15 4.59 2.15 2.67 0 4.33-1.33 5-4-1 1.33-2.17 1.83-3.5 1.5-.76-.19-1.31-.74-1.91-1.35C15.61 7.15 14.48 6 12 6zM7 12c-2.67 0-4.33 1.33-5 4 1-1.33 2.17-1.83 3.5-1.5.76.19 1.31.74 1.91 1.35.98 1 2.11 2.15 4.59 2.15 2.67 0 4.33-1.33 5-4-1 1.33-2.17 1.83-3.5 1.5-.76-.19-1.31-.74-1.91-1.35C10.61 13.15 9.48 12 7 12z"/></svg><span>Tailwind</span></button>
                    <button class="export-option" data-format="png"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg><span>PNG</span></button>
                </div>
                <div class="export-preview"><pre id="exportCode"></pre></div>
                <div class="export-actions">
                    <button class="btn-primary" id="downloadExport">Download</button>
                    <button class="btn-secondary" id="copyExport">Copy</button>
                </div>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        // ==================== COLOR UTILITIES ====================
        const ColorUtils = {
            hsbToRgb(h, s, b) {
                s /= 100; b /= 100;
                const k = n => (n + h / 60) % 6;
                const f = n => b * (1 - s * Math.max(0, Math.min(k(n), 4 - k(n), 1)));
                return [Math.round(f(5) * 255), Math.round(f(3) * 255), Math.round(f(1) * 255)];
            },
            rgbToHsb(r, g, b) {
                r /= 255; g /= 255; b /= 255;
                const max = Math.max(r, g, b), min = Math.min(r, g, b);
                const d = max - min;
                let h = 0;
                if (d !== 0) {
                    if (max === r) h = ((g - b) / d + 6) % 6;
                    else if (max === g) h = (b - r) / d + 2;
                    else h = (r - g) / d + 4;
                    h *= 60;
                }
                const s = max === 0 ? 0 : d / max * 100;
                return [Math.round(h), Math.round(s), Math.round(max * 100)];
            },
            rgbToHex(r, g, b) {
                return [r, g, b].map(x => x.toString(16).padStart(2, '0')).join('').toUpperCase();
            },
            hexToRgb(hex) {
                hex = hex.replace('#', '');
                if (hex.length === 3) hex = hex.split('').map(c => c + c).join('');
                const n = parseInt(hex, 16);
                return [(n >> 16) & 255, (n >> 8) & 255, n & 255];
            },
            rgbToCmyk(r, g, b) {
                r /= 255; g /= 255; b /= 255;
                const k = 1 - Math.max(r, g, b);
                if (k === 1) return [0, 0, 0, 100];
                return [
                    Math.round((1 - r - k) / (1 - k) * 100),
                    Math.round((1 - g - k) / (1 - k) * 100),
                    Math.round((1 - b - k) / (1 - k) * 100),
                    Math.round(k * 100)
                ];
            },
            cmykToRgb(c, m, y, k) {
                c /= 100; m /= 100; y /= 100; k /= 100;
                return [
                    Math.round(255 * (1 - c) * (1 - k)),
                    Math.round(255 * (1 - m) * (1 - k)),
                    Math.round(255 * (1 - y) * (1 - k))
                ];
            },
            rgbToLab(r, g, b) {
                let x = r / 255, y = g / 255, z = b / 255;
                x = x > 0.04045 ? Math.pow((x + 0.055) / 1.055, 2.4) : x / 12.92;
                y = y > 0.04045 ? Math.pow((y + 0.055) / 1.055, 2.4) : y / 12.92;
                z = z > 0.04045 ? Math.pow((z + 0.055) / 1.055, 2.4) : z / 12.92;
                x = (x * 0.4124 + y * 0.3576 + z * 0.1805) / 0.95047;
                y = (x * 0.2126 + y * 0.7152 + z * 0.0722) / 1.00000;
                z = (x * 0.0193 + y * 0.1192 + z * 0.9505) / 1.08883;
                x = x > 0.008856 ? Math.pow(x, 1/3) : (7.787 * x) + 16/116;
                y = y > 0.008856 ? Math.pow(y, 1/3) : (7.787 * y) + 16/116;
                z = z > 0.008856 ? Math.pow(z, 1/3) : (7.787 * z) + 16/116;
                return [Math.round((116 * y) - 16), Math.round(500 * (x - y)), Math.round(200 * (y - z))];
            },
            labToRgb(l, a, b) {
                let y = (l + 16) / 116;
                let x = a / 500 + y;
                let z = y - b / 200;
                const y3 = Math.pow(y, 3), x3 = Math.pow(x, 3), z3 = Math.pow(z, 3);
                y = y3 > 0.008856 ? y3 : (y - 16/116) / 7.787;
                x = x3 > 0.008856 ? x3 : (x - 16/116) / 7.787;
                z = z3 > 0.008856 ? z3 : (z - 16/116) / 7.787;
                x *= 0.95047; y *= 1.00000; z *= 1.08883;
                let r = x * 3.2406 + y * -1.5372 + z * -0.4986;
                let g = x * -0.9689 + y * 1.8758 + z * 0.0415;
                let bb = x * 0.0557 + y * -0.2040 + z * 1.0570;
                r = r > 0.0031308 ? 1.055 * Math.pow(r, 1/2.4) - 0.055 : 12.92 * r;
                g = g > 0.0031308 ? 1.055 * Math.pow(g, 1/2.4) - 0.055 : 12.92 * g;
                bb = bb > 0.0031308 ? 1.055 * Math.pow(bb, 1/2.4) - 0.055 : 12.92 * bb;
                return [Math.max(0, Math.min(255, Math.round(r * 255))), Math.max(0, Math.min(255, Math.round(g * 255))), Math.max(0, Math.min(255, Math.round(bb * 255)))];
            },
            simulateColorBlindness(r, g, b, type) {
                const matrices = {
                    protanopia: [[0.567,0.433,0],[0.558,0.442,0],[0,0.242,0.758]],
                    deuteranopia: [[0.625,0.375,0],[0.7,0.3,0],[0,0.3,0.7]],
                    tritanopia: [[0.95,0.05,0],[0,0.433,0.567],[0,0.475,0.525]],
                    achromatopsia: [[0.299,0.587,0.114],[0.299,0.587,0.114],[0.299,0.587,0.114]]
                };
                const m = matrices[type];
                if (!m) return [r, g, b];
                return [
                    Math.round(m[0][0]*r + m[0][1]*g + m[0][2]*b),
                    Math.round(m[1][0]*r + m[1][1]*g + m[1][2]*b),
                    Math.round(m[2][0]*r + m[2][1]*g + m[2][2]*b)
                ];
            },
            getLuminance(r, g, b) {
                const [rs, gs, bs] = [r, g, b].map(c => {
                    c /= 255;
                    return c <= 0.03928 ? c / 12.92 : Math.pow((c + 0.055) / 1.055, 2.4);
                });
                return 0.2126 * rs + 0.7152 * gs + 0.0722 * bs;
            },
            getContrastRatio(rgb1, rgb2) {
                const l1 = this.getLuminance(...rgb1);
                const l2 = this.getLuminance(...rgb2);
                const lighter = Math.max(l1, l2);
                const darker = Math.min(l1, l2);
                return (lighter + 0.05) / (darker + 0.05);
            },
            getColorName(hex) {
                const colors = {
                    'FF0000':'Red','FF7F00':'Orange','FFFF00':'Yellow','00FF00':'Lime','00FFFF':'Cyan',
                    '0000FF':'Blue','7F00FF':'Violet','FF00FF':'Magenta','FFFFFF':'White','000000':'Black',
                    '808080':'Gray','800000':'Maroon','808000':'Olive','008000':'Green','800080':'Purple',
                    '008080':'Teal','000080':'Navy','FFA500':'Orange','FFC0CB':'Pink','FFD700':'Gold'
                };
                return colors[hex] || 'Custom';
            }
        };

        // ==================== INDEXED DB ====================
        const DB_NAME = 'ChromaticDB';
        const DB_VERSION = 1;
        const STORE_NAME = 'palettes';

        let db = null;

        function openDatabase() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);

                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    db = request.result;
                    resolve(db);
                };

                request.onupgradeneeded = (e) => {
                    const database = e.target.result;
                    if (!database.objectStoreNames.contains(STORE_NAME)) {
                        const store = database.createObjectStore(STORE_NAME, { keyPath: 'id', autoIncrement: true });
                        store.createIndex('date', 'date', { unique: false });
                        store.createIndex('name', 'name', { unique: false });
                    }
                };
            });
        }

        function savePaletteDB(name = 'Untitled Palette') {
            return new Promise((resolve, reject) => {
                if (!db) return reject('Database not initialized');

                const colors = state.colors.map(c => {
                    const [r, g, b] = ColorUtils.hsbToRgb(c.h, c.s, c.b);
                    return '#' + ColorUtils.rgbToHex(r, g, b);
                });

                const palette = {
                    name,
                    colors,
                    harmony: state.harmony,
                    date: new Date().toISOString()
                };

                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.add(palette);

                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        function getAllPalettesDB() {
            return new Promise((resolve, reject) => {
                if (!db) return reject('Database not initialized');

                const transaction = db.transaction([STORE_NAME], 'readonly');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.getAll();

                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        function deletePaletteDB(id) {
            return new Promise((resolve, reject) => {
                if (!db) return reject('Database not initialized');

                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.delete(id);

                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }

        function loadPaletteFromDB(palette) {
            state.colors = palette.colors.map(hex => {
                const [r, g, b] = ColorUtils.hexToRgb(hex);
                const [h, s, br] = ColorUtils.rgbToHsb(r, g, b);
                return { h, s, b: br };
            });
            state.colorCount = state.colors.length;
            state.harmony = palette.harmony || 'custom';

            $$('.harmony-btn').forEach(b => b.classList.remove('active'));
            document.querySelector(`[data-harmony="${state.harmony}"]`).classList.add('active');
            $('colorCount').textContent = state.colorCount;

            updateHandles();
            updateUI();
        }

        // ==================== APP STATE ====================
        const state = {
            colors: [
                { h: 0, s: 100, b: 100 },
                { h: 30, s: 100, b: 100 },
                { h: 60, s: 100, b: 90 },
                { h: 150, s: 80, b: 70 },
                { h: 220, s: 90, b: 90 }
            ],
            selectedIndex: 0,
            harmony: 'custom',
            colorCount: 5,
            gradientStops: [
                { color: '#FF0000', position: 0 },
                { color: '#0000FF', position: 100 }
            ],
            gradientType: 'linear',
            gradientAngle: 90,
            selectedGradientStop: 0,
            extractedColors: []
        };

        // ==================== DOM ELEMENTS ====================
        const $ = id => document.getElementById(id);
        const $$ = sel => document.querySelectorAll(sel);

        // ==================== COLOR WHEEL ====================
        function drawColorWheel() {
            const canvas = $('colorWheel');
            const container = $('wheelContainer');
            const size = Math.min(container.clientWidth, 500);
            canvas.width = size;
            canvas.height = size;
            const ctx = canvas.getContext('2d');
            const cx = size / 2, cy = size / 2;
            const radius = size / 2 - 10;

            // Get current brightness from slider or use default
            const globalBrightness = $('globalBrightness') ? parseInt($('globalBrightness').value) : 100;

            // Draw wheel (rotated -90° so red/0° is at top)
            for (let angle = 0; angle < 360; angle += 0.5) {
                const startAngle = (angle - 0.5) * Math.PI / 180 - Math.PI / 2;
                const endAngle = (angle + 0.5) * Math.PI / 180 - Math.PI / 2;

                const gradient = ctx.createRadialGradient(cx, cy, 0, cx, cy, radius);
                const [r1, g1, b1] = ColorUtils.hsbToRgb(angle, 0, globalBrightness);
                const [r2, g2, b2] = ColorUtils.hsbToRgb(angle, 100, globalBrightness);
                gradient.addColorStop(0, `rgb(${r1},${g1},${b1})`);
                gradient.addColorStop(1, `rgb(${r2},${g2},${b2})`);

                ctx.beginPath();
                ctx.moveTo(cx, cy);
                ctx.arc(cx, cy, radius, startAngle, endAngle);
                ctx.closePath();
                ctx.fillStyle = gradient;
                ctx.fill();
            }

            updateHandles();
        }

        function updateHandles() {
            const container = $('wheelContainer');
            const size = Math.min(container.clientWidth, 500);
            const cx = size / 2, cy = size / 2;
            const radius = size / 2 - 10;

            // Remove old handles, connections, and center
            container.querySelectorAll('.wheel-handle, .wheel-connection, .wheel-center').forEach(h => h.remove());

            // Modes that should show connection lines to center
            const connectModes = ['analogous', 'triad', 'complementary', 'split-complementary', 'double-split', 'square', 'compound'];
            const showConnections = connectModes.includes(state.harmony);

            // Create SVG for connection lines if needed
            if (showConnections) {
                const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                svg.setAttribute('class', 'wheel-connection');
                svg.setAttribute('width', size);
                svg.setAttribute('height', size);
                svg.style.left = '0';
                svg.style.top = '0';

                state.colors.forEach((color) => {
                    const angle = color.h * Math.PI / 180;
                    const dist = (color.s / 100) * radius;
                    const x = cx + Math.cos(angle - Math.PI / 2) * dist;
                    const y = cy + Math.sin(angle - Math.PI / 2) * dist;

                    const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    line.setAttribute('x1', cx);
                    line.setAttribute('y1', cy);
                    line.setAttribute('x2', x);
                    line.setAttribute('y2', y);
                    svg.appendChild(line);
                });

                container.appendChild(svg);

                // Add center dot
                const centerDot = document.createElement('div');
                centerDot.className = 'wheel-center';
                centerDot.style.left = cx + 'px';
                centerDot.style.top = cy + 'px';
                container.appendChild(centerDot);
            }

            // Create new handles
            state.colors.forEach((color, i) => {
                const handle = document.createElement('div');
                handle.className = 'wheel-handle' + (i === state.selectedIndex ? ' selected' : '');
                handle.dataset.index = i;

                const angle = color.h * Math.PI / 180;
                const dist = (color.s / 100) * radius;
                const x = cx + Math.cos(angle - Math.PI / 2) * dist;
                const y = cy + Math.sin(angle - Math.PI / 2) * dist;

                handle.style.left = x + 'px';
                handle.style.top = y + 'px';
                const [r, g, b] = ColorUtils.hsbToRgb(color.h, color.s, color.b);
                handle.style.backgroundColor = `rgb(${r},${g},${b})`;

                container.appendChild(handle);
                setupHandleDrag(handle);
            });
        }

        // Global drag state for handles
        let activeDragHandle = null;
        let activeDragIndex = -1;

        function setupHandleDrag(handle) {
            const handleIndex = parseInt(handle.dataset.index);

            handle.addEventListener('mousedown', e => {
                e.preventDefault();
                e.stopPropagation();
                activeDragHandle = handle;
                activeDragIndex = handleIndex;
                handle.classList.add('active');
                state.selectedIndex = handleIndex;
                updateHandles();
                updateUI();
            });

            handle.addEventListener('touchstart', e => {
                e.preventDefault();
                activeDragHandle = handle;
                activeDragIndex = handleIndex;
                handle.classList.add('active');
                state.selectedIndex = handleIndex;
                updateHandles();
                updateUI();
            });
        }

        // Global mouse/touch handlers for dragging
        function initGlobalDragHandlers() {
            const handleDrag = (clientX, clientY) => {
                if (activeDragIndex === -1) return;

                const container = $('wheelContainer');
                const rect = container.getBoundingClientRect();
                const size = Math.min(container.clientWidth, 500);
                const cx = size / 2, cy = size / 2;
                const radius = size / 2 - 10;

                const x = clientX - rect.left - cx;
                const y = clientY - rect.top - cy;

                let angle = Math.atan2(y, x) + Math.PI / 2;
                if (angle < 0) angle += Math.PI * 2;
                const h = Math.round(angle * 180 / Math.PI) % 360;

                const dist = Math.min(Math.sqrt(x * x + y * y), radius);
                const s = Math.round((dist / radius) * 100);

                // Get current global brightness
                const globalBrightness = $('globalBrightness') ? parseInt($('globalBrightness').value) : 100;

                // For harmony modes, update the base color based on drag
                if (state.harmony !== 'custom') {
                    const oldH = state.colors[activeDragIndex].h;
                    const hueShift = h - oldH;
                    state.colors[0].h = (state.colors[0].h + hueShift + 360) % 360;
                    state.colors[0].s = s;
                    state.colors[0].b = globalBrightness;
                    applyHarmony();
                } else {
                    state.colors[activeDragIndex].h = h;
                    state.colors[activeDragIndex].s = s;
                    state.colors[activeDragIndex].b = globalBrightness;
                }

                updateHandles();
                updateUI();
            };

            document.addEventListener('mousemove', e => {
                if (activeDragIndex !== -1) {
                    handleDrag(e.clientX, e.clientY);
                }
            });

            document.addEventListener('mouseup', () => {
                if (activeDragHandle) {
                    activeDragHandle.classList.remove('active');
                }
                activeDragHandle = null;
                activeDragIndex = -1;
            });

            document.addEventListener('touchmove', e => {
                if (activeDragIndex !== -1 && e.touches[0]) {
                    handleDrag(e.touches[0].clientX, e.touches[0].clientY);
                }
            });

            document.addEventListener('touchend', () => {
                if (activeDragHandle) {
                    activeDragHandle.classList.remove('active');
                }
                activeDragHandle = null;
                activeDragIndex = -1;
            });
        }

        // ==================== HARMONY RULES ====================
        function applyHarmony() {
            const base = state.colors[0];
            const count = state.colorCount;

            switch (state.harmony) {
                case 'analogous':
                    const analogSpread = 30;
                    for (let i = 0; i < count; i++) {
                        const offset = (i - Math.floor(count / 2)) * analogSpread;
                        state.colors[i] = { h: (base.h + offset + 360) % 360, s: base.s, b: base.b };
                    }
                    break;
                case 'monochromatic':
                    for (let i = 0; i < count; i++) {
                        const bStep = 80 / (count - 1);
                        state.colors[i] = { h: base.h, s: base.s, b: 100 - i * bStep };
                    }
                    break;
                case 'triad':
                    for (let i = 0; i < count; i++) {
                        state.colors[i] = { h: (base.h + (i * 120)) % 360, s: base.s, b: base.b };
                    }
                    break;
                case 'complementary':
                    for (let i = 0; i < count; i++) {
                        const isComplement = i >= count / 2;
                        state.colors[i] = { h: isComplement ? (base.h + 180) % 360 : base.h, s: base.s, b: base.b - (i % Math.ceil(count / 2)) * 15 };
                    }
                    break;
                case 'split-complementary':
                    state.colors[0] = { ...base };
                    for (let i = 1; i < count; i++) {
                        const offset = i % 2 === 1 ? 150 : 210;
                        state.colors[i] = { h: (base.h + offset) % 360, s: base.s, b: base.b };
                    }
                    break;
                case 'double-split':
                    for (let i = 0; i < count; i++) {
                        const angles = [0, 30, 180, 210];
                        state.colors[i] = { h: (base.h + angles[i % 4]) % 360, s: base.s, b: base.b };
                    }
                    break;
                case 'square':
                    for (let i = 0; i < count; i++) {
                        state.colors[i] = { h: (base.h + i * 90) % 360, s: base.s, b: base.b };
                    }
                    break;
                case 'compound':
                    const compoundAngles = [0, 30, 180, 210, 60];
                    for (let i = 0; i < count; i++) {
                        state.colors[i] = { h: (base.h + compoundAngles[i % 5]) % 360, s: base.s, b: base.b };
                    }
                    break;
                case 'shades':
                    for (let i = 0; i < count; i++) {
                        const bStep = 80 / (count - 1);
                        state.colors[i] = { h: base.h, s: base.s, b: 100 - i * bStep };
                    }
                    break;
            }
        }

        // ==================== UI UPDATES ====================
        function updateUI() {
            const color = state.colors[state.selectedIndex];
            const [r, g, b] = ColorUtils.hsbToRgb(color.h, color.s, color.b);
            const hex = ColorUtils.rgbToHex(r, g, b);
            const [c, m, y, k] = ColorUtils.rgbToCmyk(r, g, b);
            const [l, a, bb] = ColorUtils.rgbToLab(r, g, b);

            // HSB
            $('hueSlider').value = $('hueInput').value = color.h;
            $('satSlider').value = $('satInput').value = color.s;
            $('brightSlider').value = $('brightInput').value = color.b;

            // RGB
            $('redSlider').value = $('redInput').value = r;
            $('greenSlider').value = $('greenInput').value = g;
            $('blueSlider').value = $('blueInput').value = b;

            // CMYK
            $('cyanSlider').value = $('cyanInput').value = c;
            $('magentaSlider').value = $('magentaInput').value = m;
            $('yellowSlider').value = $('yellowInput').value = y;
            $('blackSlider').value = $('blackInput').value = k;

            // LAB
            $('lSlider').value = $('lInput').value = l;
            $('aSlider').value = $('aInput').value = a;
            $('bSlider').value = $('bInput').value = bb;

            // HEX
            $('hexInput').value = hex;

            // Update slider track backgrounds
            const hue = color.h;
            $('satTrack').style.background = `linear-gradient(to right, hsl(${hue}, 0%, 50%), hsl(${hue}, 100%, 50%))`;
            $('brightTrack').style.background = `linear-gradient(to right, #000, hsl(${hue}, ${color.s}%, 50%))`;

            // Palette panel
            renderPalette();
        }

        function renderPalette() {
            const container = $('palettePanelColors');
            if (!container) return;
            container.innerHTML = '';

            state.colors.forEach((color, i) => {
                const [r, g, b] = ColorUtils.hsbToRgb(color.h, color.s, color.b);
                const hex = ColorUtils.rgbToHex(r, g, b);

                const div = document.createElement('div');
                div.className = 'palette-grid-item' + (i === state.selectedIndex ? ' selected' : '');
                div.innerHTML = `
                    <div class="palette-grid-swatch" style="background:#${hex}"></div>
                    <div class="palette-grid-info">
                        <div class="palette-grid-hex">#${hex}</div>
                        <div class="palette-grid-name">${ColorUtils.getColorName(hex)}</div>
                    </div>
                `;
                div.addEventListener('click', () => {
                    state.selectedIndex = i;
                    updateHandles();
                    updateUI();

                    // Copy hex to clipboard
                    navigator.clipboard.writeText('#' + hex);
                    showToast('Copied #' + hex);
                });
                container.appendChild(div);
            });

            // Update a11y palette
            const a11yContainer = $('a11yPaletteColors');
            if (a11yContainer) {
                a11yContainer.innerHTML = '';
                state.colors.forEach((color, i) => {
                    const [r, g, b] = ColorUtils.hsbToRgb(color.h, color.s, color.b);
                    const hex = '#' + ColorUtils.rgbToHex(r, g, b);
                    const div = document.createElement('div');
                    div.style.cssText = `width:40px;height:40px;background:${hex};border-radius:8px;cursor:pointer;border:2px solid var(--border);`;
                    div.title = hex;
                    div.addEventListener('click', () => {
                        const fg = $('fgColor');
                        fg.value = hex;
                        const [rr, gg, bb] = ColorUtils.hexToRgb(hex);
                        const [h, s, br] = ColorUtils.rgbToHsb(rr, gg, bb);
                        a11yState.fg = { h, s, b: br };
                        updateA11yHandle('fgHandle', 'fg');
                        updateContrast();
                    });
                    a11yContainer.appendChild(div);
                });
            }
        }

        // ==================== EVENT LISTENERS ====================
        function initEventListeners() {
            // Navigation
            $$('.nav-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    $$('.nav-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    $$('.view').forEach(v => v.classList.remove('active'));
                    $(`${tab.dataset.view}View`).classList.add('active');
                });
            });

            // Theme
            $$('.theme-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    $$('.theme-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    document.body.className = btn.dataset.theme === 'dark' ? '' : `theme-${btn.dataset.theme}`;
                });
            });

            // Harmony
            $$('.harmony-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    $$('.harmony-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    state.harmony = btn.dataset.harmony;
                    if (state.harmony !== 'custom') applyHarmony();
                    updateHandles();
                    updateUI();
                });
            });

            // Color count
            $('decreaseColors').addEventListener('click', () => {
                if (state.colorCount > 2) {
                    state.colorCount--;
                    state.colors.pop();
                    $('colorCount').textContent = state.colorCount;
                    if (state.selectedIndex >= state.colorCount) state.selectedIndex = state.colorCount - 1;
                    if (state.harmony !== 'custom') applyHarmony();
                    updateHandles();
                    updateUI();
                }
            });

            $('increaseColors').addEventListener('click', () => {
                if (state.colorCount < 10) {
                    state.colorCount++;
                    state.colors.push({ h: Math.random() * 360, s: 80, b: 80 });
                    $('colorCount').textContent = state.colorCount;
                    if (state.harmony !== 'custom') applyHarmony();
                    updateHandles();
                    updateUI();
                }
            });

            // Global brightness
            $('globalBrightness').addEventListener('input', e => {
                const brightness = parseInt(e.target.value);
                $('brightnessValue').textContent = brightness + '%';
                state.colors.forEach(c => c.b = brightness);
                drawColorWheel(); // Redraw wheel with new brightness
                updateUI();
            });

            // Slider tabs
            $$('.slider-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    $$('.slider-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    $$('.slider-group').forEach(g => g.classList.remove('active'));
                    document.querySelector(`.slider-group[data-mode="${tab.dataset.mode}"]`).classList.add('active');
                });
            });

            // HSB sliders
            ['hue', 'sat', 'bright'].forEach(name => {
                const slider = $(`${name}Slider`);
                const input = $(`${name}Input`);
                const update = val => {
                    const prop = name === 'hue' ? 'h' : name === 'sat' ? 's' : 'b';
                    state.colors[state.selectedIndex][prop] = parseInt(val);
                    if (state.harmony !== 'custom' && state.harmony !== 'shades') applyHarmony();
                    updateHandles();
                    updateUI();
                };
                slider.addEventListener('input', e => update(e.target.value));
                input.addEventListener('change', e => update(e.target.value));
            });

            // RGB sliders
            ['red', 'green', 'blue'].forEach(name => {
                const slider = $(`${name}Slider`);
                const input = $(`${name}Input`);
                const update = () => {
                    const r = parseInt($('redSlider').value);
                    const g = parseInt($('greenSlider').value);
                    const b = parseInt($('blueSlider').value);
                    const [h, s, br] = ColorUtils.rgbToHsb(r, g, b);
                    state.colors[state.selectedIndex] = { h, s, b: br };
                    updateHandles();
                    updateUI();
                };
                slider.addEventListener('input', update);
                input.addEventListener('change', update);
            });

            // CMYK sliders
            ['cyan', 'magenta', 'yellow', 'black'].forEach(name => {
                const slider = $(`${name}Slider`);
                const input = $(`${name}Input`);
                const update = () => {
                    const c = parseInt($('cyanSlider').value);
                    const m = parseInt($('magentaSlider').value);
                    const y = parseInt($('yellowSlider').value);
                    const k = parseInt($('blackSlider').value);
                    const [r, g, b] = ColorUtils.cmykToRgb(c, m, y, k);
                    const [h, s, br] = ColorUtils.rgbToHsb(r, g, b);
                    state.colors[state.selectedIndex] = { h, s, b: br };
                    updateHandles();
                    updateUI();
                };
                slider.addEventListener('input', update);
                input.addEventListener('change', update);
            });

            // LAB sliders
            ['l', 'a', 'b'].forEach(name => {
                const slider = $(`${name}Slider`);
                const input = $(`${name}Input`);
                const update = () => {
                    const l = parseInt($('lSlider').value);
                    const a = parseInt($('aSlider').value);
                    const b = parseInt($('bSlider').value);
                    const [r, g, bb] = ColorUtils.labToRgb(l, a, b);
                    const [h, s, br] = ColorUtils.rgbToHsb(r, g, bb);
                    state.colors[state.selectedIndex] = { h, s, b: br };
                    updateHandles();
                    updateUI();
                };
                slider.addEventListener('input', update);
                input.addEventListener('change', update);
            });

            // Hex input
            $('hexInput').addEventListener('change', e => {
                const hex = e.target.value.replace('#', '');
                if (/^[0-9A-Fa-f]{6}$/.test(hex)) {
                    const [r, g, b] = ColorUtils.hexToRgb(hex);
                    const [h, s, br] = ColorUtils.rgbToHsb(r, g, b);
                    state.colors[state.selectedIndex] = { h, s, b: br };
                    updateHandles();
                    updateUI();
                }
            });

            // Copy hex
            $('copyHex').addEventListener('click', () => {
                navigator.clipboard.writeText('#' + $('hexInput').value);
                showToast('Copied to clipboard!');
            });

            // Export modal
            $('exportBtn').addEventListener('click', () => {
                $('exportModal').classList.add('active');
                updateExportPreview();
            });

            $('closeExport').addEventListener('click', () => $('exportModal').classList.remove('active'));
            $('exportModal').querySelector('.modal-overlay').addEventListener('click', () => $('exportModal').classList.remove('active'));

            $$('.export-option').forEach(opt => {
                opt.addEventListener('click', () => {
                    $$('.export-option').forEach(o => o.classList.remove('active'));
                    opt.classList.add('active');
                    updateExportPreview();
                });
            });

            $('copyExport').addEventListener('click', () => {
                navigator.clipboard.writeText($('exportCode').textContent);
                showToast('Copied to clipboard!');
            });

            $('downloadExport').addEventListener('click', downloadExport);

            // Image extraction
            $('uploadZone').addEventListener('click', () => $('imageInput').click());
            $('imageInput').addEventListener('change', handleImageUpload);
            $('uploadZone').addEventListener('dragover', e => { e.preventDefault(); e.currentTarget.style.borderColor = 'var(--accent)'; });
            $('uploadZone').addEventListener('dragleave', e => e.currentTarget.style.borderColor = '');
            $('uploadZone').addEventListener('drop', e => {
                e.preventDefault();
                e.currentTarget.style.borderColor = '';
                if (e.dataTransfer.files[0]) {
                    $('imageInput').files = e.dataTransfer.files;
                    handleImageUpload();
                }
            });

            $('applyExtracted').addEventListener('click', () => {
                if (state.extractedColors.length) {
                    state.colors = state.extractedColors.slice(0, state.colorCount).map(hex => {
                        const [r, g, b] = ColorUtils.hexToRgb(hex);
                        const [h, s, br] = ColorUtils.rgbToHsb(r, g, b);
                        return { h, s, b: br };
                    });
                    state.harmony = 'custom';
                    $$('.harmony-btn').forEach(b => b.classList.remove('active'));
                    document.querySelector('[data-harmony="custom"]').classList.add('active');
                    updateHandles();
                    updateUI();
                    showToast('Colors applied to palette!');
                }
            });

            // Gradient
            initGradient();

            // Accessibility
            initAccessibility();

            // Canvas click
            $('colorWheel').addEventListener('click', e => {
                const rect = e.target.getBoundingClientRect();
                const size = Math.min(e.target.width, e.target.height);
                const cx = size / 2, cy = size / 2;
                const radius = size / 2 - 10;

                const x = e.clientX - rect.left - cx;
                const y = e.clientY - rect.top - cy;
                const dist = Math.sqrt(x * x + y * y);

                if (dist <= radius) {
                    let angle = Math.atan2(y, x) + Math.PI / 2;
                    if (angle < 0) angle += Math.PI * 2;
                    const h = Math.round(angle * 180 / Math.PI) % 360;
                    const s = Math.round((dist / radius) * 100);

                    // Get current global brightness
                    const globalBrightness = $('globalBrightness') ? parseInt($('globalBrightness').value) : 100;

                    state.colors[state.selectedIndex].h = h;
                    state.colors[state.selectedIndex].s = s;
                    state.colors[state.selectedIndex].b = globalBrightness;

                    if (state.harmony !== 'custom' && state.harmony !== 'shades') {
                        applyHarmony();
                    }

                    updateHandles();
                    updateUI();
                }
            });

            // Save palette
            $('saveBtn').addEventListener('click', async () => {
                try {
                    await savePaletteDB('Palette ' + new Date().toLocaleString());
                    showToast('Palette saved!');
                } catch (err) {
                    console.error('Failed to save palette:', err);
                    showToast('Failed to save palette');
                }
            });

            // Window resize
            window.addEventListener('resize', () => {
                drawColorWheel();
            });
        }

        // ==================== GRADIENT ====================
        function initGradient() {
            renderGradient();

            $$('.gradient-type-btns button').forEach(btn => {
                btn.addEventListener('click', () => {
                    $$('.gradient-type-btns button').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    state.gradientType = btn.dataset.type;
                    $('anglePanel').style.display = state.gradientType === 'linear' ? 'block' : 'none';
                    renderGradient();
                });
            });

            $('gradientAngle').addEventListener('input', e => {
                state.gradientAngle = parseInt(e.target.value);
                $('angleInput').value = state.gradientAngle;
                renderGradient();
            });

            $('angleInput').addEventListener('change', e => {
                state.gradientAngle = parseInt(e.target.value);
                $('gradientAngle').value = state.gradientAngle;
                renderGradient();
            });

            $('addStop').addEventListener('click', () => {
                if (state.gradientStops.length >= 4) return; // Max 4 colors

                // Find a good position for new stop (middle of largest gap)
                const sorted = [...state.gradientStops].sort((a, b) => a.position - b.position);
                let maxGap = 0, gapStart = 0;
                for (let i = 0; i < sorted.length - 1; i++) {
                    const gap = sorted[i + 1].position - sorted[i].position;
                    if (gap > maxGap) {
                        maxGap = gap;
                        gapStart = sorted[i].position;
                    }
                }
                const newPos = gapStart + maxGap / 2;

                // Pick a color that blends between neighbors
                const randomHue = Math.floor(Math.random() * 360);
                const [r, g, b] = ColorUtils.hsbToRgb(randomHue, 70, 80);
                const newColor = '#' + ColorUtils.rgbToHex(r, g, b);

                state.gradientStops.push({ color: newColor, position: Math.round(newPos) });
                state.gradientStops.sort((a, b) => a.position - b.position);
                renderGradient();
            });

            $('reverseGradient').addEventListener('click', () => {
                state.gradientStops.forEach(s => s.position = 100 - s.position);
                state.gradientStops.reverse();
                renderGradient();
            });

            $('copyGradient').addEventListener('click', () => {
                navigator.clipboard.writeText($('gradientCSS').textContent);
                showToast('Copied to clipboard!');
            });
        }

        function renderGradient() {
            const stops = state.gradientStops.map(s => `${s.color} ${s.position}%`).join(', ');
            let css;

            switch (state.gradientType) {
                case 'radial':
                    css = `radial-gradient(circle, ${stops})`;
                    break;
                case 'conic':
                    css = `conic-gradient(from ${state.gradientAngle}deg, ${stops})`;
                    break;
                default:
                    css = `linear-gradient(${state.gradientAngle}deg, ${stops})`;
            }

            $('gradientPreview').style.background = css;
            $('gradientTrack').style.background = `linear-gradient(to right, ${stops})`;
            $('gradientCSS').textContent = css;

            // Show/hide add button based on color count (max 4)
            const addBtn = $('addStop');
            if (addBtn) {
                addBtn.style.display = state.gradientStops.length >= 4 ? 'none' : 'block';
            }

            // Render color list in panel
            const colorsList = $('gradientColorsList');
            if (colorsList) {
                colorsList.innerHTML = '';
                state.gradientStops.forEach((stop, i) => {
                    const item = document.createElement('div');
                    item.className = 'gradient-color-item';
                    item.innerHTML = `
                        <div class="gradient-color-swatch" style="background:${stop.color}">
                            <input type="color" value="${stop.color}" data-index="${i}">
                        </div>
                        <div class="gradient-color-controls">
                            <div class="gradient-color-hex">${stop.color.toUpperCase()}</div>
                            <div class="gradient-position-row">
                                <input type="range" min="0" max="100" value="${stop.position}" data-index="${i}">
                                <span>${stop.position}%</span>
                            </div>
                        </div>
                        <button class="gradient-color-remove" data-index="${i}" ${state.gradientStops.length <= 2 ? 'disabled' : ''}>&times;</button>
                    `;

                    // Color picker change
                    item.querySelector('input[type="color"]').addEventListener('input', e => {
                        state.gradientStops[i].color = e.target.value;
                        renderGradient();
                    });

                    // Position slider change
                    item.querySelector('input[type="range"]').addEventListener('input', e => {
                        state.gradientStops[i].position = parseInt(e.target.value);
                        renderGradient();
                    });

                    // Remove button
                    item.querySelector('.gradient-color-remove').addEventListener('click', e => {
                        if (state.gradientStops.length > 2) {
                            state.gradientStops.splice(i, 1);
                            renderGradient();
                        }
                    });

                    colorsList.appendChild(item);
                });
            }

            // Render stops on track
            const stopsContainer = $('gradientStops');
            stopsContainer.innerHTML = '';

            state.gradientStops.forEach((stop, i) => {
                const div = document.createElement('div');
                div.className = 'gradient-stop' + (i === state.selectedGradientStop ? ' active' : '');
                div.style.left = stop.position + '%';
                div.style.backgroundColor = stop.color;

                let isDragging = false;

                div.addEventListener('mousedown', e => {
                    e.preventDefault();
                    isDragging = true;
                    state.selectedGradientStop = i;

                    const onMove = e => {
                        if (!isDragging) return;
                        const rect = stopsContainer.getBoundingClientRect();
                        let pos = ((e.clientX - rect.left) / rect.width) * 100;
                        pos = Math.max(0, Math.min(100, pos));
                        stop.position = Math.round(pos);
                        renderGradient();
                    };

                    const onUp = () => {
                        isDragging = false;
                        document.removeEventListener('mousemove', onMove);
                        document.removeEventListener('mouseup', onUp);
                    };

                    document.addEventListener('mousemove', onMove);
                    document.addEventListener('mouseup', onUp);
                });

                stopsContainer.appendChild(div);
            });
        }

        // ==================== ACCESSIBILITY ====================
        const a11yState = {
            fg: { h: 0, s: 0, b: 0 },
            bg: { h: 0, s: 0, b: 100 }
        };

        function drawA11yWheel(canvasId, handleId, colorKey) {
            const canvas = $(canvasId);
            const container = canvas.parentElement;
            const size = 150;
            canvas.width = size;
            canvas.height = size;
            const ctx = canvas.getContext('2d');
            const cx = size / 2, cy = size / 2;
            const radius = size / 2 - 5;

            // Draw wheel (rotated -90° so red/0° is at top)
            for (let angle = 0; angle < 360; angle += 1) {
                const startAngle = (angle - 0.5) * Math.PI / 180 - Math.PI / 2;
                const endAngle = (angle + 0.5) * Math.PI / 180 - Math.PI / 2;

                const gradient = ctx.createRadialGradient(cx, cy, 0, cx, cy, radius);
                const [r1, g1, b1] = ColorUtils.hsbToRgb(angle, 0, 100);
                const [r2, g2, b2] = ColorUtils.hsbToRgb(angle, 100, 100);
                gradient.addColorStop(0, `rgb(${r1},${g1},${b1})`);
                gradient.addColorStop(1, `rgb(${r2},${g2},${b2})`);

                ctx.beginPath();
                ctx.moveTo(cx, cy);
                ctx.arc(cx, cy, radius, startAngle, endAngle);
                ctx.closePath();
                ctx.fillStyle = gradient;
                ctx.fill();
            }

            // Update handle position
            updateA11yHandle(handleId, colorKey);
        }

        function updateA11yHandle(handleId, colorKey) {
            const handle = $(handleId);
            const color = a11yState[colorKey];
            const size = 150;
            const cx = size / 2, cy = size / 2;
            const radius = size / 2 - 5;

            const angle = color.h * Math.PI / 180;
            const dist = (color.s / 100) * radius;
            const x = cx + Math.cos(angle - Math.PI / 2) * dist;
            const y = cy + Math.sin(angle - Math.PI / 2) * dist;

            handle.style.left = x + 'px';
            handle.style.top = y + 'px';
            const [r, g, b] = ColorUtils.hsbToRgb(color.h, color.s, color.b);
            handle.style.backgroundColor = `rgb(${r},${g},${b})`;
        }

        function setupA11yWheelDrag(canvasId, handleId, inputId, colorKey) {
            const canvas = $(canvasId);
            let isDragging = false;

            const updateColor = (e) => {
                const rect = canvas.getBoundingClientRect();
                const size = 150;
                const cx = size / 2, cy = size / 2;
                const radius = size / 2 - 5;

                const x = e.clientX - rect.left - cx;
                const y = e.clientY - rect.top - cy;

                let angle = Math.atan2(y, x) + Math.PI / 2;
                if (angle < 0) angle += Math.PI * 2;
                const h = Math.round(angle * 180 / Math.PI) % 360;

                const dist = Math.min(Math.sqrt(x * x + y * y), radius);
                const s = Math.round((dist / radius) * 100);

                a11yState[colorKey].h = h;
                a11yState[colorKey].s = s;
                a11yState[colorKey].b = 100;

                const [r, g, b] = ColorUtils.hsbToRgb(h, s, 100);
                const hex = '#' + ColorUtils.rgbToHex(r, g, b);
                $(inputId).value = hex;

                updateA11yHandle(handleId, colorKey);
                updateContrast();
            };

            canvas.addEventListener('mousedown', (e) => {
                isDragging = true;
                updateColor(e);
            });

            document.addEventListener('mousemove', (e) => {
                if (isDragging) updateColor(e);
            });

            document.addEventListener('mouseup', () => {
                isDragging = false;
            });

            canvas.addEventListener('touchstart', (e) => {
                e.preventDefault();
                isDragging = true;
                updateColor(e.touches[0]);
            });

            document.addEventListener('touchmove', (e) => {
                if (isDragging) updateColor(e.touches[0]);
            });

            document.addEventListener('touchend', () => {
                isDragging = false;
            });
        }

        function initAccessibility() {
            // Draw mini color wheels
            drawA11yWheel('fgWheel', 'fgHandle', 'fg');
            drawA11yWheel('bgWheel', 'bgHandle', 'bg');

            // Setup wheel interactions
            setupA11yWheelDrag('fgWheel', 'fgHandle', 'fgColor', 'fg');
            setupA11yWheelDrag('bgWheel', 'bgHandle', 'bgColor', 'bg');

            // Hex input change handlers
            ['fg', 'bg'].forEach(prefix => {
                const input = $(`${prefix}Color`);

                input.addEventListener('change', () => {
                    let val = input.value;
                    if (!val.startsWith('#')) val = '#' + val;
                    input.value = val;

                    const [r, g, b] = ColorUtils.hexToRgb(val);
                    const [h, s, br] = ColorUtils.rgbToHsb(r, g, b);
                    a11yState[prefix] = { h, s, b: br };

                    updateA11yHandle(`${prefix}Handle`, prefix);
                    updateContrast();
                });
            });

            $('swapColors').addEventListener('click', () => {
                const fg = $('fgColor').value;
                const bg = $('bgColor').value;
                $('fgColor').value = bg;
                $('bgColor').value = fg;

                const temp = { ...a11yState.fg };
                a11yState.fg = { ...a11yState.bg };
                a11yState.bg = temp;

                updateA11yHandle('fgHandle', 'fg');
                updateA11yHandle('bgHandle', 'bg');
                updateContrast();
            });

            updateContrast();
        }

        function updateContrast() {
            const fg = $('fgColor').value;
            const bg = $('bgColor').value;

            const fgRgb = ColorUtils.hexToRgb(fg);
            const bgRgb = ColorUtils.hexToRgb(bg);
            const ratio = ColorUtils.getContrastRatio(fgRgb, bgRgb);

            $('contrastRatio').textContent = ratio.toFixed(2) + ':1';
            $('contrastPreview').style.backgroundColor = bg;
            $('contrastPreview').style.color = fg;

            // WCAG checks
            const aaNormal = ratio >= 4.5;
            const aaLarge = ratio >= 3;
            const aaaNormal = ratio >= 7;
            const aaaLarge = ratio >= 4.5;

            $('aaNormal').textContent = aaNormal ? 'Pass' : 'Fail';
            $('aaNormal').className = 'wcag-status ' + (aaNormal ? 'pass' : 'fail');
            $('aaLarge').textContent = aaLarge ? 'Pass' : 'Fail';
            $('aaLarge').className = 'wcag-status ' + (aaLarge ? 'pass' : 'fail');
            $('aaaNormal').textContent = aaaNormal ? 'Pass' : 'Fail';
            $('aaaNormal').className = 'wcag-status ' + (aaaNormal ? 'pass' : 'fail');
            $('aaaLarge').textContent = aaaLarge ? 'Pass' : 'Fail';
            $('aaaLarge').className = 'wcag-status ' + (aaaLarge ? 'pass' : 'fail');
        }

        // ==================== IMAGE EXTRACTION ====================
        function handleImageUpload() {
            const file = $('imageInput').files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = e => {
                const img = $('previewImage');
                img.src = e.target.result;
                $('uploadZone').classList.add('has-image');

                img.onload = () => {
                    extractColors(img);
                };
            };
            reader.readAsDataURL(file);
        }

        function extractColors(img) {
            const canvas = $('extractCanvas');
            const ctx = canvas.getContext('2d');

            const maxSize = 100;
            const scale = Math.min(maxSize / img.width, maxSize / img.height);
            canvas.width = img.width * scale;
            canvas.height = img.height * scale;

            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const pixels = imageData.data;

            // Simple color quantization
            const colorCounts = {};
            for (let i = 0; i < pixels.length; i += 4) {
                const r = Math.round(pixels[i] / 32) * 32;
                const g = Math.round(pixels[i + 1] / 32) * 32;
                const b = Math.round(pixels[i + 2] / 32) * 32;
                const key = `${r},${g},${b}`;
                colorCounts[key] = (colorCounts[key] || 0) + 1;
            }

            const sortedColors = Object.entries(colorCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 15)  // Get more to detect if there are too many
                .map(([rgb]) => {
                    const [r, g, b] = rgb.split(',').map(Number);
                    return '#' + ColorUtils.rgbToHex(r, g, b);
                });

            state.extractedColors = sortedColors;
            renderExtractedColors();
            $('applyExtracted').disabled = false;
        }

        function renderExtractedColors() {
            const container = $('extractedColors');
            container.innerHTML = '';

            // Show warning if too many colors
            if (state.extractedColors.length > 10) {
                const warning = document.createElement('p');
                warning.style.cssText = 'color:var(--warning);font-size:13px;margin-bottom:12px;';
                warning.textContent = 'Too many colors for palette. Showing top 10.';
                container.appendChild(warning);
            }

            // Only show first 10 colors
            const colorsToShow = state.extractedColors.slice(0, 10);

            colorsToShow.forEach((hex, i) => {
                const div = document.createElement('div');
                div.className = 'extracted-color';
                div.innerHTML = `
                    <div class="extracted-swatch" style="background:${hex}"></div>
                    <div class="extracted-info">
                        <div class="extracted-hex">${hex}</div>
                    </div>
                `;
                div.addEventListener('click', () => {
                    navigator.clipboard.writeText(hex);
                    showToast('Copied ' + hex);
                });
                container.appendChild(div);
            });
        }

        // ==================== EXPORT ====================
        function updateExportPreview() {
            const format = document.querySelector('.export-option.active').dataset.format;
            const colors = state.colors.map((c, i) => {
                const [r, g, b] = ColorUtils.hsbToRgb(c.h, c.s, c.b);
                return { hex: '#' + ColorUtils.rgbToHex(r, g, b), name: `color-${i + 1}` };
            });

            let code = '';
            switch (format) {
                case 'css':
                    code = `:root {\n${colors.map(c => `  --${c.name}: ${c.hex};`).join('\n')}\n}`;
                    break;
                case 'scss':
                    code = colors.map(c => `$${c.name}: ${c.hex};`).join('\n');
                    break;
                case 'json':
                    code = JSON.stringify({ colors: colors.map(c => c.hex) }, null, 2);
                    break;
                case 'tailwind':
                    code = `module.exports = {\n  theme: {\n    extend: {\n      colors: {\n${colors.map(c => `        '${c.name}': '${c.hex}'`).join(',\n')}\n      }\n    }\n  }\n}`;
                    break;
                case 'png':
                    code = '[PNG image will be generated on download]';
                    break;
            }

            $('exportCode').textContent = code;
        }

        function downloadExport() {
            const format = document.querySelector('.export-option.active').dataset.format;
            const colors = state.colors.map(c => {
                const [r, g, b] = ColorUtils.hsbToRgb(c.h, c.s, c.b);
                return '#' + ColorUtils.rgbToHex(r, g, b);
            });

            if (format === 'png') {
                const canvas = document.createElement('canvas');
                canvas.width = colors.length * 100;
                canvas.height = 100;
                const ctx = canvas.getContext('2d');
                colors.forEach((color, i) => {
                    ctx.fillStyle = color;
                    ctx.fillRect(i * 100, 0, 100, 100);
                });
                const link = document.createElement('a');
                link.download = 'palette.png';
                link.href = canvas.toDataURL();
                link.click();
            } else {
                const content = $('exportCode').textContent;
                const ext = { css: 'css', scss: 'scss', json: 'json', tailwind: 'js' }[format];
                const blob = new Blob([content], { type: 'text/plain' });
                const link = document.createElement('a');
                link.download = `palette.${ext}`;
                link.href = URL.createObjectURL(blob);
                link.click();
            }

            showToast('Downloaded!');
        }

        // ==================== TOAST ====================
        function showToast(message) {
            const toast = $('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2000);
        }

        // ==================== INIT ====================
        async function init() {
            // Initialize IndexedDB
            try {
                await openDatabase();
                console.log('IndexedDB initialized');
            } catch (err) {
                console.warn('IndexedDB not available, using fallback');
            }

            initGlobalDragHandlers();
            drawColorWheel();
            updateUI();
            initEventListeners();
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
